<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>보드게임 레이팅 시스템</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
        }
        
        .section {
            padding: 30px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .section:last-child {
            border-bottom: none;
        }
        
        h2 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .icon {
            font-size: 1.5em;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .player-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .player-tag {
            padding: 8px 16px;
            background: #f0f0f0;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .player-tag .remove {
            cursor: pointer;
            color: #999;
            font-weight: bold;
        }
        
        .player-tag .remove:hover {
            color: #ff4444;
        }
        
        .game-input {
            margin-top: 20px;
        }
        
        .rank-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 8px;
        }
        
        .rank-number {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        select {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .ranking-table th,
        .ranking-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .ranking-table th {
            background: #f8f8f8;
            font-weight: 600;
        }
        
        .ranking-table tr:hover {
            background: #f8f8f8;
        }
        
        .rank-medal {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        
        .rank-1 { background: gold; color: #333; }
        .rank-2 { background: silver; color: #333; }
        .rank-3 { background: #CD7F32; }
        .rank-other { background: #999; }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            flex: 1;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎲 보드게임 레이팅 시스템</h1>
            <p>TrueSkill 알고리즘으로 실력을 측정해보세요!</p>
        </div>
        
        <div class="section">
            <h2>
                <span class="icon">👥</span>
                플레이어 관리
            </h2>
            <div class="input-group">
                <input type="text" id="playerNameInput" placeholder="플레이어 이름을 입력하세요">
                <button onclick="addPlayer()">추가</button>
            </div>
            <div class="player-list" id="playerList"></div>
        </div>
        
        <div class="section">
            <h2>
                <span class="icon">🎮</span>
                게임 결과 입력
            </h2>
            <div id="gameInput" class="game-input"></div>
            <button onclick="recordGame()" style="width: 100%; margin-top: 20px;">게임 결과 기록</button>
        </div>
        
        <div class="section">
            <h2>
                <span class="icon">🏆</span>
                순위표
            </h2>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalGames">0</div>
                    <div class="stat-label">총 게임 수</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalPlayers">0</div>
                    <div class="stat-label">총 플레이어 수</div>
                </div>
            </div>
            <div id="rankingTable"></div>
        </div>
    </div>
    
    <script>
        // Simple TrueSkill implementation
        class Rating {
            constructor(mu = 25, sigma = 25/3) {
                this.mu = mu;
                this.sigma = sigma;
            }
        }
        
        class TrueSkillSimple {
            constructor() {
                this.players = {};
                this.gameHistory = [];
            }
            
            addPlayer(name) {
                if (!this.players[name]) {
                    this.players[name] = {
                        rating: new Rating(),
                        games: 0,
                        wins: 0
                    };
                    this.saveToStorage();
                }
            }
            
            removePlayer(name) {
                delete this.players[name];
                this.saveToStorage();
            }
            
            recordGame(rankings) {
                // 간단한 TrueSkill 근사
                const K = 32; // ELO-like K factor
                
                rankings.forEach((playerName, rank) => {
                    if (!this.players[playerName]) return;
                    
                    const player = this.players[playerName];
                    player.games++;
                    
                    if (rank === 0) player.wins++;
                    
                    // 각 플레이어와의 매치업 계산
                    rankings.forEach((opponentName, opponentRank) => {
                        if (playerName === opponentName) return;
                        
                        const opponent = this.players[opponentName];
                        const ratingDiff = opponent.rating.mu - player.rating.mu;
                        const expectedScore = 1 / (1 + Math.pow(10, ratingDiff / 400));
                        const actualScore = rank < opponentRank ? 1 : 0;
                        
                        // 레이팅 업데이트
                        const change = K * (actualScore - expectedScore) / rankings.length;
                        player.rating.mu += change;
                    });
                    
                    // 시그마 감소 (게임할수록 확실해짐)
                    player.rating.sigma = Math.max(2, player.rating.sigma * 0.99);
                });
                
                // 게임 기록 저장
                this.gameHistory.push({
                    date: new Date().toISOString(),
                    rankings: rankings
                });
                
                this.saveToStorage();
            }
            
            getDisplayRating(playerName) {
                const player = this.players[playerName];
                if (!player) return 0;
                return Math.round((player.rating.mu - 3 * player.rating.sigma) * 40);
            }
            
            getRankings() {
                return Object.entries(this.players)
                    .map(([name, data]) => ({
                        name,
                        score: this.getDisplayRating(name),
                        games: data.games,
                        wins: data.wins,
                        winRate: data.games > 0 ? Math.round(data.wins / data.games * 100) : 0
                    }))
                    .sort((a, b) => b.score - a.score);
            }
            
            saveToStorage() {
                localStorage.setItem('trueskillData', JSON.stringify({
                    players: this.players,
                    gameHistory: this.gameHistory
                }));
            }
            
            loadFromStorage() {
                const data = localStorage.getItem('trueskillData');
                if (data) {
                    const parsed = JSON.parse(data);
                    this.players = parsed.players || {};
                    this.gameHistory = parsed.gameHistory || [];
                    
                    // Rating 객체 복원
                    Object.values(this.players).forEach(player => {
                        player.rating = new Rating(player.rating.mu, player.rating.sigma);
                    });
                }
            }
        }
        
        // 전역 인스턴스
        const game = new TrueSkillSimple();
        
        // 페이지 로드시 초기화
        window.onload = function() {
            game.loadFromStorage();
            updatePlayerList();
            updateGameInput();
            updateRankingTable();
        };
        
        // 엔터키로 플레이어 추가
        document.getElementById('playerNameInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addPlayer();
            }
        });
        
        function addPlayer() {
            const input = document.getElementById('playerNameInput');
            const name = input.value.trim();
            
            if (name && !game.players[name]) {
                game.addPlayer(name);
                input.value = '';
                updatePlayerList();
                updateGameInput();
                updateRankingTable();
            }
        }
        
        function removePlayer(name) {
            if (confirm(`${name} 플레이어를 삭제하시겠습니까?`)) {
                game.removePlayer(name);
                updatePlayerList();
                updateGameInput();
                updateRankingTable();
            }
        }
        
        function updatePlayerList() {
            const list = document.getElementById('playerList');
            const players = Object.keys(game.players);
            
            if (players.length === 0) {
                list.innerHTML = '<div class="empty-state">등록된 플레이어가 없습니다</div>';
            } else {
                list.innerHTML = players.map(name => `
                    <div class="player-tag">
                        ${name}
                        <span class="remove" onclick="removePlayer('${name}')">✕</span>
                    </div>
                `).join('');
            }
            
            document.getElementById('totalPlayers').textContent = players.length;
        }
        
        function updateGameInput() {
            const container = document.getElementById('gameInput');
            const players = Object.keys(game.players);
            
            if (players.length < 2) {
                container.innerHTML = '<div class="empty-state">최소 2명의 플레이어가 필요합니다</div>';
            } else {
                container.innerHTML = Array.from({length: players.length}, (_, i) => `
                    <div class="rank-input">
                        <div class="rank-number">${i + 1}등</div>
                        <select id="rank${i}">
                            <option value="">선택하세요</option>
                            ${players.map(name => `<option value="${name}">${name}</option>`).join('')}
                        </select>
                    </div>
                `).join('');
            }
        }
        
        function recordGame() {
            const players = Object.keys(game.players);
            const rankings = [];
            const selected = new Set();
            
            for (let i = 0; i < players.length; i++) {
                const select = document.getElementById(`rank${i}`);
                if (!select || !select.value) {
                    alert('모든 순위를 입력해주세요!');
                    return;
                }
                
                if (selected.has(select.value)) {
                    alert('같은 플레이어를 여러 순위에 입력할 수 없습니다!');
                    return;
                }
                
                rankings.push(select.value);
                selected.add(select.value);
            }
            
            game.recordGame(rankings);
            updateRankingTable();
            updateGameInput();
            
            // 입력 초기화
            for (let i = 0; i < players.length; i++) {
                document.getElementById(`rank${i}`).value = '';
            }
            
            alert('게임 결과가 기록되었습니다!');
        }
        
        function updateRankingTable() {
            const container = document.getElementById('rankingTable');
            const rankings = game.getRankings();
            
            document.getElementById('totalGames').textContent = game.gameHistory.length;
            
            if (rankings.length === 0) {
                container.innerHTML = '<div class="empty-state">아직 데이터가 없습니다</div>';
            } else {
                container.innerHTML = `
                    <table class="ranking-table">
                        <thead>
                            <tr>
                                <th>순위</th>
                                <th>플레이어</th>
                                <th>레이팅</th>
                                <th>게임 수</th>
                                <th>승리</th>
                                <th>승률</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rankings.map((player, index) => `
                                <tr>
                                    <td>
                                        <div class="rank-medal ${index < 3 ? `rank-${index + 1}` : 'rank-other'}">
                                            ${index + 1}
                                        </div>
                                    </td>
                                    <td><strong>${player.name}</strong></td>
                                    <td>${player.score}</td>
                                    <td>${player.games}</td>
                                    <td>${player.wins}</td>
                                    <td>${player.winRate}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
        }
    </script>
</body>
</html>
